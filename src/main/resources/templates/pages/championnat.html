<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- D√©finition du jeu de caract√®res et des param√®tres de mise en page responsive -->
    <meta charset="UTF-8">
    <title>Classement du Championnat</title>

    <!-- Ic√¥ne affich√©e dans l'onglet du navigateur -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.png">

    <!-- Inclusion du fichier CSS externe pour le style -->
    <link rel="stylesheet" href="/css/StyleChamp.css">

</head>

<body>

<!-- Barre de navigation -->
<nav>
    <div class="logo">üèÅ Courses</div>
    <ul class="nav-links">
        <li><a th:href="@{/}">Accueil</a></li>
        <li><a th:href="@{/championnat(club=${club})}">Championnat</a></li>
        <li><a th:href="@{/contact}">Contact</a></li>
    </ul>
</nav>

<!-- Titre principal -->
<h1 class="title">Classement du Championnat</h1>

<!-- Filtres par cat√©gorie -->
<div class="filters">
    <label for="categorie">Cat√©gorie :</label>
    <select id="categorie" name="categorie" onchange="updateURL()">
        <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}" th:selected="${selectedCategory == cat}"></option>
    </select>
</div>

<script>
    function updateURL() {
        let select = document.getElementById("categorie");
        let selectedValue = select.value;
        if (!selectedValue) return;
        let url = new URL(window.location.href);
        url.searchParams.set('categorie', selectedValue);
        window.location.href = url.toString();
    }
</script>

<script th:inline="javascript">
    const raceResults = /*[[${raceResults}]]*/ {};
</script>

<!-- Tableau principal -->
<h2 class="subtitle">Classement G√©n√©ral</h2>
<table id="raceTable">
    <thead>
    <tr id="headerRow">
        <th>Position</th>
        <th>Nom</th>
        <th>Total</th>
        <th id="sortTotal1">Total - 1 üîΩ</th>
    </tr>
    </thead>
    <tbody id="raceBody"></tbody>
</table>

<!-- Tableau pour les pilotes avec * -->
<h2 class="subtitle">Classement cat√©gorie bis</h2>
<table id="excludedTable">
    <thead>
    <tr id="excludedHeaderRow">
        <th>Position</th>
        <th>Nom</th>
        <th>Total</th>
        <th>Total - 1</th>
    </tr>
    </thead>
    <tbody id="excludedBody"></tbody>
</table>

<script>
    const tableHeader = document.getElementById("headerRow");
    const excludedHeader = document.getElementById("excludedHeaderRow");
    const tableBody = document.getElementById("raceBody");
    const excludedBody = document.getElementById("excludedBody");
    const sortButton = document.getElementById("sortTotal1");

    const dates = Object.keys(raceResults);

    // Ajouter les dates comme en-t√™tes de colonne pour les deux tableaux
    dates.forEach(date => {
        let th1 = document.createElement("th");
        th1.textContent = date;
        tableHeader.appendChild(th1);

        let th2 = document.createElement("th");
        th2.textContent = date;
        excludedHeader.appendChild(th2);
    });

    function processPilotes() {
        tableBody.innerHTML = "";
        excludedBody.innerHTML = "";

        let allNames = new Set();
        dates.forEach(date => {
            Object.keys(raceResults[date]).forEach(name => allNames.add(name));
        });

        let pilotes = [...allNames].map(name => {
            let total = 0;
            let scores = [];

            dates.forEach(date => {
                let score = raceResults[date][name] ?? 0;
                total += score;
                scores.push(score);
            });

            let total1 = total;
            let nonZeroScores = scores.filter(s => s > 0);

            if (nonZeroScores.length > 1) {
                let minScore = Math.min(...nonZeroScores);
                total1 -= minScore;
            }

            return { name, total, total1, scores };
        });

        let excludedPilotes = pilotes.filter(p => p.name.includes("*"));
        let validPilotes = pilotes.filter(p => !p.name.includes("*"));

        // Trier par Total - 1
        validPilotes.sort((a, b) => b.total1 - a.total1);

        function appendToTable(body, pilote) {
            let tr = document.createElement("tr");

            let tdPosition = document.createElement("td");
            tdPosition.textContent = body.children.length + 1;
            tr.appendChild(tdPosition);

            let tdName = document.createElement("td");
            tdName.textContent = pilote.name;
            tr.appendChild(tdName);

            let tdTotal = document.createElement("td");
            tdTotal.textContent = pilote.total;
            tr.appendChild(tdTotal);

            let tdTotal1 = document.createElement("td");
            tdTotal1.textContent = pilote.total1;
            tr.appendChild(tdTotal1);

            pilote.scores.forEach(score => {
                let td = document.createElement("td");
                td.textContent = score || "-";
                tr.appendChild(td);
            });

            body.appendChild(tr);
        }

        validPilotes.forEach(p => appendToTable(tableBody, p));
        excludedPilotes.forEach(p => appendToTable(excludedBody, p));
    }

    processPilotes();
    sortButton.addEventListener("click", processPilotes);
</script>

</body>
</html>
