<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Classement du Championnat</title>
    <style>
        body {
            background-color: #f8f9fa;
            color: #000;
            font-family: Arial, sans-serif;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #1a1a1a;
            color: white;
        }
        th, td {
            border: 1px solid red;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }
        th {
            background-color: #333;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        th:hover {
            background-color: #555;
        }
        tr:nth-child(odd) { background-color: #222; }
        tr:nth-child(even) { background-color: #111; }
        td:first-child { font-weight: bold; }
        .total { font-weight: bold; background-color: #444; }
    </style>
</head>
<body>

<h1 style="text-align: center;">Classement du Championnat</h1>

<!-- Filtres par catÃ©gorie -->
<div style="text-align: center;">
    <label for="categorie">CatÃ©gorie :</label>
    <select id="categorie" name="categorie" onchange="updateURL()">
        <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}" th:selected="${selectedCategory == cat}"></option>
    </select>
</div>

<script>
    function updateURL() {
        let select = document.getElementById("categorie");
        let selectedValue = select.value;

        if (!selectedValue) return;

        let url = new URL(window.location.href);
        url.searchParams.set('categorie', selectedValue);

        console.log("Redirection vers : " + url.toString());
        window.location.href = url.toString();
    }
</script>

<script th:inline="javascript">
    const raceResults = /*[[${raceResults}]]*/ {};
    console.log("DonnÃ©es raceResults :", raceResults);
</script>

<table id="raceTable">
    <thead>
    <tr id="headerRow">
        <th>Nom</th>
        <th>Total</th>
        <th id="sortTotal1">Total - 1 ðŸ”½</th> <!-- Click pour trier -->
    </tr>
    </thead>
    <tbody id="raceBody"></tbody>
</table>
<script>
    const tableHeader = document.getElementById("headerRow");
    const tableBody = document.getElementById("raceBody");
    const sortButton = document.getElementById("sortTotal1");

    const dates = Object.keys(raceResults);

    // Ajouter les dates comme en-tÃªtes de colonne
    dates.forEach(date => {
        let th = document.createElement("th");
        th.textContent = date;
        tableHeader.appendChild(th);
    });

    function updateTable() {
        tableBody.innerHTML = ""; // RÃ©initialisation du tableau avant affichage

        let allNames = new Set();
        dates.forEach(date => {
            Object.keys(raceResults[date]).forEach(name => allNames.add(name));
        });

        let pilotes = [...allNames].map(name => {
            let total = 0;
            let scores = [];

            dates.forEach(date => {
                let score = raceResults[date][name] ?? 0;
                total += score;
                scores.push(score);
            });

            // Suppression du plus mauvais score seulement s'il y a plusieurs scores
            let total1 = total;
            if (scores.length > 1) {
                let minScore = Math.min(...scores);
                total1 -= minScore;
            }

            return { name, total, total1, scores };
        });

        // Tri par "Total - 1" (ordre dÃ©croissant)
        pilotes.sort((a, b) => b.total1 - a.total1);

        pilotes.forEach(pilote => {
            let tr = document.createElement("tr");

            let tdName = document.createElement("td");
            tdName.textContent = pilote.name;
            tr.appendChild(tdName);

            let tdTotal = document.createElement("td");
            tdTotal.textContent = pilote.total;
            tr.appendChild(tdTotal);

            let tdTotal1 = document.createElement("td");
            tdTotal1.textContent = (pilote.scores.length > 1) ? pilote.total1 : pilote.total; // Correction ici
            tr.appendChild(tdTotal1);

            pilote.scores.forEach(score => {
                let td = document.createElement("td");
                td.textContent = score || "-";
                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });
    }

    // Mettre Ã  jour le tableau au chargement
    updateTable();

    // Ajoute un Ã©vÃ©nement pour trier au clic sur "Total - 1"
    sortButton.addEventListener("click", () => {
        updateTable();
    });

</script>



</body>
</html>
