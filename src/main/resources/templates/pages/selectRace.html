<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>S√©lection de la Course</title>
  <link rel="stylesheet" href="../css/SelectRaceStyle.css">
</head>
<body>

<!-- NAVIGATION BAR -->
<nav>
  <div class="logo">üèÅ Courses</div>
  <ul class="nav-links">
    <li><a th:href="@{/}">Accueil</a></li>
    <li><a th:href="@{/courses}">Courses</a></li>
    <li><a th:href="@{/championnat(club=${club})}">Championnat</a></li>
    <li><a th:href="@{/contact}">Contact</a></li>
    <li><a href="#" id="uploadButton">Ajouter une course</a></li>
  </ul>
</nav>

<form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" style="display: none;">
  <input type="file" id="fileInput" name="file" accept=".xls,.xlsx">
  <input type="hidden" id="clubInput" name="club" th:value="${club}">
</form>

<div style="display: flex">
  <aside>
    <h3>Filtres</h3>
    <label for="categoryFilter">Cat√©gorie :</label>
    <select id="categoryFilter">
      <option value="">Toutes</option>
      <option th:each="categorie : ${listeCategorie}" th:value="${categorie}" th:text="${categorie}"></option>
    </select>
    <button onclick="applyFilters()">Appliquer</button>
  </aside>

  <main>
    <h2>Liste des Courses</h2>
    <img th:if="${club == 'slot4000'}" src="../images/images.jfif" alt="Slot4000">
    <img th:if="${club == 'srcs'}" src="../images/SRCS.png" alt="SRCS">

    <div class="container" id="raceContainer">
      <th:block th:if="${raceResultDate != null and not #maps.isEmpty(raceResultDate)}">
        <form th:each="entry : ${raceResultDate}" th:action="@{/processRaceDate}" method="post">
          <button type="submit" class="race-card"
                  th:attr="data-club=${club}, data-category=${entry.value}">
            <div class="race-date" th:text="${entry.key}"></div>
            <div class="race-category" th:text="${entry.value}"></div>
            <input type="hidden" name="raceDate" th:value="${entry.key}">
          </button>
        </form>
      </th:block>
      <p class="no-race" th:if="${#maps.isEmpty(raceResultDate)}">Aucune course disponible.</p>
    </div>
    <a th:href="@{/home}" class="back-home">Retour √† l'accueil</a>
  </main>
</div>

<script>
  function applyFilters() {
    let categoryFilter = document.getElementById("categoryFilter").value.toLowerCase();
    let raceCards = document.querySelectorAll(".race-card");

    raceCards.forEach(card => {
      let cardCategory = card.getAttribute("data-category").toLowerCase();
      let showCard = categoryFilter === "" || categoryFilter === cardCategory;
      card.style.display = showCard ? "" : "none";
    });
  }

  document.getElementById("uploadButton").addEventListener("click", function () {
    let password = prompt("Veuillez entrer le mot de passe pour ajouter un fichier :");

    if (!password) {
      alert("Mot de passe requis !");
      return;
    }

    fetch("/api/verify-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: password })
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                document.getElementById("fileInput").click();
              } else {
                alert("Mot de passe incorrect !");
              }
            })
            .catch(error => console.error("Erreur lors de la validation du mot de passe", error));
  });

  document.getElementById("fileInput").addEventListener("change", function () {
    let formData = new FormData(document.getElementById("uploadForm"));
    let club = document.getElementById("clubInput").value;

    if (!club) {
      alert("Erreur : Club non sp√©cifi√© !");
      return;
    }

    fetch("/upload", {
      method: "POST",
      body: formData
    })
            .then(response => response.text())
            .then(data => {
              alert(`Fichier t√©l√©charg√© avec succ√®s pour le club : ${club}`);
              window.location.reload();
            })
            .catch(error => {
              console.error("Erreur lors de l'upload :", error);
              alert("√âchec du t√©l√©chargement.");
            });
  });
</script>

</body>
</html>
